<!-- c:\Users\mosa\Desktop\Project3\df\admin.html -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم الدكتور - Master Admin</title>
    <link rel="stylesheet" href="style.css?v=10">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="admin-body">

    <!-- Gatekeeper Overlay -->
    <div id="loadingOverlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#020204; z-index:9999; display:flex; align-items:center; justify-content:center; flex-direction:column;">
        <i id="lockIcon" class="fa-solid fa-shield-halved" style="font-size:4rem; color:var(--neon-green); margin-bottom:20px; animation:heartBeat 1.5s infinite;"></i>
        <h3 id="lockText" style="color:#fff; margin-bottom: 20px;">جاري التحقق من الصلاحيات...</h3>
        <input type="password" id="secretCode" placeholder="كود التفعيل السري" style="display:none; padding:10px 20px; border-radius:30px; border:1px solid #333; background:#111; color:#fff; text-align:center; width:250px; outline:none;">
        <button id="secretBtn" onclick="activateMaster()" style="display:none; margin-top:15px; padding:10px 30px; background:var(--neon-red); color:#fff; border:none; border-radius:30px; cursor:pointer; font-weight:bold;">تفعيل وضع المستر</button>
    </div>

    <style>
        .split-container {
            display: flex;
            width: 100%;
            min-height: 100vh;
            padding-top: 20px;
        }
        .section {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        .boys-section {
            border-left: 2px solid #333;
            background: rgba(0, 100, 255, 0.05);
        }
        .girls-section {
            background: rgba(255, 0, 100, 0.05);
        }
        .section-title {
            text-align: center;
            font-size: 2rem;
            margin-bottom: 30px;
            font-weight: 900;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .boys-title { color: #00d2ff; }
        .girls-title { color: #ff3366; }

        .user-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }
        .user-card {
            background: #111;
            border: 1px solid #333;
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            transition: 0.3s;
        }
        .user-card:hover { transform: translateY(-5px); border-color: #fff; }
        .user-img {
            width: 100px; height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #333;
            margin-bottom: 10px;
            cursor: pointer;
            transition: 0.3s;
        }
        .user-img:hover { transform: scale(1.1); border-color: var(--neon-green); }
        .user-name { font-weight: bold; color: #fff; margin-bottom: 5px; font-size: 1.1rem; }
        .user-phone { color: var(--neon-green); font-family: monospace; font-size: 1rem; }
        
        /* Lightbox */
        .img-modal {
            display: none; position: fixed; z-index: 10000;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            align-items: center; justify-content: center;
        }
        .img-modal img { max-width: 90%; max-height: 90vh; border-radius: 10px; box-shadow: 0 0 50px rgba(255,255,255,0.2); }
        .close-img { position: absolute; top: 20px; right: 30px; color: #fff; font-size: 3rem; cursor: pointer; }
    </style>

    <div class="admin-container" id="adminPanel" style="opacity:0; transition:1s; display: block;">
        
        <div style="position: fixed; top: 20px; left: 20px; z-index: 100;">
            <button onclick="logout()" style="background: #333; color: #fff; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">خروج</button>
        </div>

        <div class="split-container">
            <!-- قسم الأولاد -->
            <div class="section boys-section">
                <h2 class="section-title boys-title"><i class="fa-solid fa-mars"></i> الأولاد</h2>
                <div class="user-grid" id="boysGrid">
                    <!-- سيتم إضافة الكروت هنا -->
                </div>
            </div>

            <!-- قسم البنات -->
            <div class="section girls-section">
                <h2 class="section-title girls-title"><i class="fa-solid fa-venus"></i> البنات</h2>
                <div class="user-grid" id="girlsGrid">
                    <!-- سيتم إضافة الكروت هنا -->
                </div>
            </div>
        </div>

    </div>

    <!-- Image Modal -->
    <div id="imgModal" class="img-modal" onclick="this.style.display='none'">
        <span class="close-img">&times;</span>
        <img id="modalImg" src="">
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getDatabase, ref, push, serverTimestamp, onValue, get, update, remove } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyD092yeOowtCLW0fDcIzaEXrnxvrN4X5T8", authDomain: "abqarieno.firebaseapp.com", databaseURL: "https://abqarieno-default-rtdb.firebaseio.com", projectId: "abqarieno", storageBucket: "abqarieno.firebasestorage.app", messagingSenderId: "790682500839", appId: "1:790682500839:web:cd50b8e01729f821e06c42" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        let currentUserUid = null;

        // --- Admin Logic ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserUid = user.uid;
                // التحقق من الصلاحية من قاعدة البيانات
                const snapshot = await get(ref(db, 'users/' + user.uid));
                const userData = snapshot.val();
                
                if (userData && userData.role === 'admin') {
                    // المستخدم أدمن بالفعل -> افتح اللوحة
                    document.getElementById('loadingOverlay').style.display = 'none';
                    document.getElementById('adminPanel').style.opacity = '1';
                    initDashboard();
                } else {
                    // المستخدم ليس أدمن -> اطلب الكود السري
                    document.getElementById('lockIcon').className = "fa-solid fa-lock";
                    document.getElementById('lockIcon').style.color = "var(--neon-red)";
                    document.getElementById('lockIcon').style.animation = "none";
                    document.getElementById('lockText').innerText = "أدخل كود المستر للوصول";
                    document.getElementById('secretCode').style.display = "block";
                    document.getElementById('secretBtn').style.display = "block";
                }
            } else {
                window.location.href = "auth.html";
            }
        });

        // دالة تفعيل وضع المستر بالكود السري
        window.activateMaster = function() {
            const code = document.getElementById('secretCode').value;
            if (code === "2028") {
                // الترقية الفورية في قاعدة البيانات
                update(ref(db, 'users/' + currentUserUid), {
                    role: 'admin'
                }).then(() => {
                    alert("تم تفعيل وضع المستر بنجاح! أهلاً بك يا دكتور.");
                    location.reload(); // إعادة تحميل لتطبيق الصلاحيات الجديدة
                });
            } else {
                alert("الكود غير صحيح!");
            }
        }

        window.logout = function() {
            signOut(auth).then(() => window.location.href = "auth.html");
        }

        function initDashboard() {
            // جلب المستخدمين وتوزيعهم
            onValue(ref(db, 'users'), (snapshot) => {
                const boysGrid = document.getElementById('boysGrid');
                const girlsGrid = document.getElementById('girlsGrid');
                
                boysGrid.innerHTML = '';
                girlsGrid.innerHTML = '';

                snapshot.forEach((childSnapshot) => {
                    const u = childSnapshot.val();
                    
                    // تخطي الأدمن
                    if(u.role === 'admin') return;

                    const imgSrc = u.photoURL || 'https://via.placeholder.com/100';
                    const name = u.username || 'بدون اسم';
                    const phone = u.phone || 'لا يوجد رقم';

                    const cardHTML = `
                        <div class="user-card">
                            <img src="${imgSrc}" class="user-img" onclick="showImg('${imgSrc}')">
                            <div class="user-name">${name}</div>
                            <div class="user-phone">${phone}</div>
                        </div>
                    `;

                    if (u.gender === 'male') {
                        boysGrid.innerHTML += cardHTML;
                    } else if (u.gender === 'female') {
                        girlsGrid.innerHTML += cardHTML;
                    } else {
                        // في حالة عدم تحديد النوع (مستخدمين قدامى)، نضعهم في الأولاد افتراضياً أو نتجاهلهم
                        boysGrid.innerHTML += cardHTML; 
                    }
                });
            });
        }

        window.showImg = function(src) {
            document.getElementById('modalImg').src = src;
            document.getElementById('imgModal').style.display = 'flex';
        }
    </script>
</body>
</html>
